{
  "category": "Uncategorized",
  "description": "Fix Habit Reset Logic to Respect User Timezone\n\nCorrect the habit completion tracking system to properly handle day boundaries based on the user's local timezone rather than server time or UTC.\n\nRequirements:\n- Identify where habit completion timestamps are currently being stored and compared\n- Ensure all date/time comparisons use the user's timezone, not server/UTC time\n- Implement proper \"start of day\" calculation based on user's timezone (e.g., midnight in user's local time)\n- Reset habit completion status when a new day begins in the user's timezone\n- Handle edge cases:\n  * Users traveling across timezones\n  * Daylight saving time transitions\n  * Users changing their timezone settings\n  * Habits completed near midnight boundary\n- Verify that habits checked yesterday appear unchecked today in the user's local time\n- Ensure the fix works consistently across different timezone offsets (+/- UTC)\n- Test with users in various timezones (PST, EST, GMT, JST, etc.) to confirm correct behavior\n\nTechnical Considerations:\n- Store timestamps in UTC but convert to user timezone for display and reset logic\n- Retrieve and apply user's timezone preference from their profile/settings\n- Update any scheduled tasks or cron jobs to account for per-user timezone differences",
  "title": "Fix habit reset logic for user timezone",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "claude-opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "branchName": "main",
  "priority": 2,
  "planningMode": "skip",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770822912501-uiolgvl07k",
  "descriptionHistory": [
    {
      "description": "Fix Habit Reset Logic to Respect User Timezone\n\nCorrect the habit completion tracking system to properly handle day boundaries based on the user's local timezone rather than server time or UTC.\n\nRequirements:\n- Identify where habit completion timestamps are currently being stored and compared\n- Ensure all date/time comparisons use the user's timezone, not server/UTC time\n- Implement proper \"start of day\" calculation based on user's timezone (e.g., midnight in user's local time)\n- Reset habit completion status when a new day begins in the user's timezone\n- Handle edge cases:\n  * Users traveling across timezones\n  * Daylight saving time transitions\n  * Users changing their timezone settings\n  * Habits completed near midnight boundary\n- Verify that habits checked yesterday appear unchecked today in the user's local time\n- Ensure the fix works consistently across different timezone offsets (+/- UTC)\n- Test with users in various timezones (PST, EST, GMT, JST, etc.) to confirm correct behavior\n\nTechnical Considerations:\n- Store timestamps in UTC but convert to user timezone for display and reset logic\n- Retrieve and apply user's timezone preference from their profile/settings\n- Update any scheduled tasks or cron jobs to account for per-user timezone differences",
      "timestamp": "2026-02-11T15:15:12.622Z",
      "source": "initial"
    }
  ],
  "startedAt": "2026-02-11T15:15:17.237Z",
  "updatedAt": "2026-02-11T15:26:11.932Z",
  "justFinishedAt": "2026-02-11T15:26:11.922Z",
  "summary": "## Summary: Fix Habit Reset Logic to Respect User Timezone\n\n### Changes Implemented\n- Created new `timezoneUtils.ts` with comprehensive timezone-aware date utility functions\n- Fixed `getTodayDate()` in `habitLogService.ts` to use local timezone instead of UTC\n- Fixed `getTodayDateString()`, `getYesterdayDateString()`, and `addDays()` in `streakService.ts` to use local timezone\n- Fixed `getTodayDate()`, `getDayOfWeek()`, `getWeekStart()`, `getMonthStart()`, `addDays()`, and `getPeriodStartDate()` in `statisticsService.ts` to use local timezone\n- Fixed `getPastDates()` in `adminService.ts` to use local timezone\n- Fixed date formatting in `HabitRecentLogs.tsx` component to use local timezone for \"Today\"/\"Yesterday\" comparison\n- Fixed date tracking in `useNotificationSettings.ts` to use local timezone\n- Fixed default date in `useStatistics.ts` to use local timezone\n- Updated example code comments in `useHabitLogs.ts` to show correct local timezone approach\n- Exported new timezone utility functions from the database module index\n\n### Files Modified\n- `src/lib/database/timezoneUtils.ts` (new file)\n- `src/lib/database/habitLogService.ts`\n- `src/lib/database/streakService.ts`\n- `src/lib/database/statisticsService.ts`\n- `src/lib/database/adminService.ts`\n- `src/lib/database/useNotificationSettings.ts`\n- `src/lib/database/useStatistics.ts`\n- `src/lib/database/useHabitLogs.ts`\n- `src/lib/database/index.ts`\n- `src/components/habits/HabitRecentLogs.tsx`\n\n### Notes for Developer\n- The core issue was that `toISOString().split('T')[0]` was being used throughout the codebase, which converts dates to UTC before formatting. For users in timezones behind UTC (like US timezones), this caused habits to appear completed for the wrong day.\n- The fix changes all date calculations to use local timezone by building YYYY-MM-DD strings directly from `getFullYear()`, `getMonth()`, and `getDate()` which return local timezone values.\n- When parsing date strings back to Date objects, the code now appends `'T12:00:00'` (noon) to avoid edge cases during DST transitions.\n- The existing timezone stored in notification settings is preserved and can be used for more advanced features like displaying times in a specific timezone.\n- TypeScript compilation passes with no errors."
}